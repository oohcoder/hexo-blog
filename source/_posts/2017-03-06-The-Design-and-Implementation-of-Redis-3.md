title: Redis设计与实现总结——多机数据库的实现
date: 2017-03-06 19:19:41
tags: [redis]
---

## 复制
在Redis中用户可以通过执行`SLAVEOF`命令或者设置`slaveof`选项，让一个服务器去复制(repliacte)另一个服务器，被复制的服务器称为主服务器(master),而对服务器进行复制的服务器被称为从服务器(salve)。
复制功能分为同步(sync)和命令传播(command propagate)两个操作:
* 同步操作用于将从服务器的数据库状态更新至主服务器当前所处的数据库状态。(从服务器主动向主服务器请求数据)
* 命令传播操作用于在主服务器的数据库状态被修改，导致主从服务器数据库状态出现不一致时，让主服务器的数据库重新回到一致状态。

![redis旧版复制](/assets/img/redis/redis_sync.png)
* 同步过程:
    * 主服务器接收到从服务器发来的SYNC命令,执行BGSAVE命令,创建RDB文件,并使用缓冲区记录接下来执行的所有写命令。
    * 从服务器接收并载入主服务器发来的RDB文件。
    * 主服务器接着发送缓冲区的写命令到从服务器。
    * 从服务器接收命令。
* 命令传播:
    每当主服务器执行写命令时，主服务器的数据库状态就可能被修改，并导致主从服务器不一致。为了再次回到一致状态，主服务器需要对从服务器执行命令传播操作: 主服务器会将自己执行的写命令发送给从服务器执行，当从服务器执行了相同的写命令后，主从服务器再次回到一致状态。

从服务器初次复制主服务器或者从服务器当前要复制的主服务器和上一次不一样时，RDB文件会完整的传输。在处于命令传播阶段的主从服务器因为网络原因而中断了复制，再次连接上时会重头开始复制。但是第二种情况的效率非常低，很多已经复制过的数据需要再次进行复制。这就是旧版复制功能的缺陷。
新版复制功能为了解决重复复制的问题，提出了一个`PSYNC`命令代替之前的`SYNC`命令。完整的复制与上面的第一种情况初次复制是一样的，部分重同步则用于处理短线后的情况: 断线再连接后，主服务器只发送断线期间的写命令到从服务器。
部分重同步的实现是通过`复制偏移量`:
* 主服务器每次向从服务器转播N个字节的数据时，就将自己的复制偏移量的值+N
* 从服务器每次收到主服务器传播来的N个字节数据时，就将自己的复制偏移量的值+N

通过对比主从服务器的复制偏移量，程序可以很容易地知道主从服务器是否处于一致状态:
* 如果主从服务器处于一致状态，那么主从服务器两者的偏移量总是相同的
* 相反，如果主从服务器两者的偏移量并不相同，那么说明主从服务器并未处于一致状态

复制积压缓冲区是一个由主服务器维护的固定长度，先进先出队列，默认大小为1MB。当主从断开连接，再次连接时,从服务器会通过`PSYNC`将自己的复制偏移量`offset`发送给主服务器:
* 如果`offset`偏移量之后的数据竟然存在于复制积压缓冲区，那么主服务器将对从服务器执行部分重同步操作。
* 如果`offset`偏移量之后的数据已经不存在于复制积压缓冲区，那么主服务器会对从服务器执行完整重同步操作。

在命令传播阶段，从服务器默认会以每秒一次的频率，祥主服务器发送命令`REPLICONF ACK <replication_offset>`, 其中`replication_offset`是当前从服务器的复制偏移量, 这个`心跳检测`的作用如下:
* **检测主从服务器的网络状态**:如果主服务器超过一秒钟没收到从服务器发送的`REPLICONF ACK`命令，那么主服务器就知道主从服务器之间的连接出现问题了。
* **辅助实现min-slaves选项**:Redis的`min-slaves-to-write`和`min-slaves-max-log`两个选项可以防止主服务器在不安全的情况下执行写命令。
* **检测命令丢失**:如果因为网络故障，主服务器传播给从服务器的写命令半路丢失，那么从服务器发送的偏移量就会小于主服务器的偏移量，这时候主服务器会从复制积压缓冲区中重新把命令发送给从服务器。(2.8版本之前没有这个功能，所以会出现丢失的情况)

## Sentinel
## 集群
